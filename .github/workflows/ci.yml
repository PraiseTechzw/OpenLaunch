name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Repository
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: Validate repository structure
      run: |
        echo "Validating repository structure..."
        
        # Check required files exist
        required_files=(
          "README.md"
          "CONTRIBUTING.md"
          "CODE_OF_CONDUCT.md"
          "LICENSE"
          ".gitignore"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "❌ Missing required file: $file"
            exit 1
          else
            echo "✅ Found: $file"
          fi
        done
        
        # Check required directories exist
        required_dirs=(
          ".github"
          "docs"
          "community"
          "scripts"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "❌ Missing required directory: $dir"
            exit 1
          else
            echo "✅ Found: $dir"
          fi
        done
        
        echo "Repository structure validation passed!"
        
    - name: Lint Markdown files
      run: |
        # Install markdownlint-cli if not already installed
        if ! command -v markdownlint &> /dev/null; then
          npm install -g markdownlint-cli
        fi
        
        echo "Linting Markdown files..."
        
        # Create markdownlint config
        cat > .markdownlint.json << EOF
        {
          "MD013": false,
          "MD033": false,
          "MD041": false
        }
        EOF
        
        # Lint all markdown files
        markdownlint "**/*.md" --config .markdownlint.json || true
        
        echo "Markdown linting completed!"
        
    - name: Check links in documentation
      run: |
        echo "Checking for broken internal links..."
        
        # Simple link checker for internal links
        find . -name "*.md" -type f -exec grep -l "\[.*\](.*\.md)" {} \; | while read file; do
          echo "Checking links in: $file"
          grep -o "\[.*\](.*\.md)" "$file" | sed 's/.*](\(.*\.md\)).*/\1/' | while read link; do
            # Remove anchor links
            clean_link=$(echo "$link" | sed 's/#.*//')
            if [ ! -f "$clean_link" ] && [ ! -f "./$clean_link" ]; then
              echo "⚠️  Potential broken link in $file: $link"
            fi
          done
        done
        
        echo "Link checking completed!"
        
    - name: Validate issue templates
      run: |
        echo "Validating GitHub issue templates..."
        
        if [ -d ".github/ISSUE_TEMPLATE" ]; then
          template_count=$(find .github/ISSUE_TEMPLATE -name "*.yml" -o -name "*.yaml" | wc -l)
          if [ "$template_count" -gt 0 ]; then
            echo "✅ Found $template_count issue template(s)"
          else
            echo "⚠️  No YAML issue templates found"
          fi
        else
          echo "⚠️  No issue template directory found"
        fi
        
    - name: Check for security best practices
      run: |
        echo "Checking security best practices..."
        
        # Check if sensitive files are properly ignored
        if grep -q "\.env" .gitignore; then
          echo "✅ Environment files are ignored"
        else
          echo "⚠️  Consider adding .env to .gitignore"
        fi
        
        if grep -q "node_modules" .gitignore; then
          echo "✅ node_modules is ignored"
        else
          echo "⚠️  Consider adding node_modules to .gitignore"
        fi
        
        # Check for common sensitive patterns
        if find . -name "*.md" -exec grep -l "password\|secret\|key" {} \; | grep -v ".git" | head -5; then
          echo "⚠️  Found potential sensitive information in documentation"
        fi
        
        echo "Security check completed!"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, creating minimal test setup"
          npm init -y
          npm install --save-dev jest
        fi
        
    - name: Run tests
      run: |
        if [ -f package.json ] && grep -q "test" package.json; then
          npm test
        else
          echo "No tests configured yet - this is expected for initial setup"
          echo "Tests will be added as the project develops"
        fi

  build:
    name: Build Project
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found - build step will be added later"
        fi
        
    - name: Build project
      run: |
        if [ -f package.json ] && grep -q "build" package.json; then
          npm run build
        else
          echo "No build script configured yet"
          echo "Build process will be added as components are developed"
        fi

  accessibility:
    name: Accessibility Check
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check documentation accessibility
      run: |
        echo "Checking documentation for accessibility best practices..."
        
        # Check for alt text patterns in markdown
        find . -name "*.md" -exec grep -l "!\[.*\]" {} \; | while read file; do
          echo "Checking images in: $file"
          grep "!\[.*\]" "$file" | while read line; do
            if echo "$line" | grep -q "!\[\s*\]"; then
              echo "⚠️  Empty alt text found in $file: $line"
            fi
          done
        done
        
        # Check for heading structure
        find . -name "*.md" -exec grep -H "^#" {} \; | head -20
        
        echo "Accessibility check completed!"

  community:
    name: Community Health Check
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check community health files
      run: |
        echo "Checking community health files..."
        
        community_files=(
          "CODE_OF_CONDUCT.md"
          "CONTRIBUTING.md"
          "LICENSE"
        )
        
        for file in "${community_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
            wc -l "$file" | awk '{print "   Lines: " $1}'
          else
            echo "❌ Missing: $file"
          fi
        done
        
        # Check if README has basic sections
        if grep -q "## Getting Started\|## Installation\|## Usage" README.md; then
          echo "✅ README has getting started information"
        else
          echo "⚠️  README could benefit from getting started section"
        fi
        
        if grep -q "## Contributing\|## Contribution" README.md; then
          echo "✅ README mentions contributing"
        else
          echo "⚠️  README could benefit from contribution information"
        fi
        
        echo "Community health check completed!"